=================================================
How to Build Flows with Structured LLM Generation
=================================================

This guide explains how to generate structured output using Large Language Models (LLMs) within flows in Agent Spec.
Structured generation ensures outputs are actionable and usable, enabling seamless integration into subsequent steps of your flow or application.

This guide will show you how to:

- Configure LLMs to generate structured outputs within flows.
- Handle simple and complex JSON objects using specific schemas.

Basic Implementation
====================

Flows in Agent Spec often include nodes that depend on messages or data generated by a Large Language Model (LLM).
To define these nodes, you must specify the LLM configuration.
Multiple backend options are supported, such as the `OCI Generative AI service <https://www.oracle.com/artificial-intelligence/generative-ai/generative-ai-service/>`_ or a self-hosted model using vLLM.

.. include:: ../_components/llm_config_tabs.rst

Let's walk through an example of summarizing an article. Start by defining the content to be summarized:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-article
    :end-before: .. end-article

Now, define the flow for this summarization task:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-flow1
    :end-before: .. end-flow1

This flow can be exported to json by:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-serialization1
    :end-before: .. end-serialization1

Here is what the **Agent Spec representation will look like ↓**

.. collapse:: Click here to see the assistant configuration.

   .. tabs::

      .. tab:: JSON

         .. literalinclude:: ../agentspec_config_examples/howto_summary_flow.json
            :language: json

      .. tab:: YAML

         .. literalinclude:: ../agentspec_config_examples/howto_summary_flow.yaml
            :language: yaml

It can be loaded into any Agent Spec-compatible system, such as the `WayFlow <https://github.com/oracle/wayflow>`_ runtime.
See, for example, :doc:`How to Execute Agent Spec Configuration with WayFlow <howto_execute_agentspec_with_wayflow>`.

Structured Generation with Flows
================================

Generating raw text within a flow is often not useful, as it can be challenging to utilize in subsequent steps.
Instead, let us consider generating data that adheres to a specific schema for easier processing.
Let us define three outputs that the flow can produce.

Instead of generating only a summary, you can provide three distinct outputs to the :class:`LlmNode` for generation.

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured11
    :end-before: .. end-structured11

The rest of the pieces in the flow remain the same:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured12
    :end-before: .. end-structured12

Here is what the **Agent Spec representation will look like ↓**

.. collapse:: Click here to see the assistant configuration.

   .. tabs::

      .. tab:: JSON

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation1.json
            :language: json

      .. tab:: YAML

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation1.yaml
            :language: yaml

Complex JSON Objects
====================

In some scenarios, you may need to generate an object that conforms to a specific JSON schema. This can be achieved as follows:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured21
    :end-before: .. end-structured21

Note the difference from the previous example: there were three separate outputs, whereas here, a single object encapsulates all data as specified by the schema.
Rest of the flow remain the same.

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured22
    :end-before: .. end-structured22

Here is what the **Agent Spec representation will look like ↓**

.. collapse:: Click here to see the assistant configuration.

   .. tabs::

      .. tab:: JSON

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation2.json
            :language: json

      .. tab:: YAML

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation2.yaml
            :language: yaml

Structured Generation with Agents
=================================

For more advanced use cases, you may need to invoke additional tools within your flow to process or act on data.
You can configure an agent which can do this and it can be used to generate specific structured outputs as shown below:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured31
    :end-before: .. end-structured31

Here, the :class:`AgentNode` is used, which incorporates an :class:`Agent` and supports outputs similar to :class:`LlmNode`.
However, the agent offers additional capabilities beyond simple generation which can be useful in many scenarios.

Again, rest of the flow construction looks the same:

.. literalinclude:: ../code_examples/howto_structured_generation.py
    :language: python
    :start-after: .. start-structured32
    :end-before: .. end-structured32

Here is what the **Agent Spec representation will look like ↓**

.. collapse:: Click here to see the assistant configuration.

   .. tabs::

      .. tab:: JSON

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation3.json
            :language: json

      .. tab:: YAML

         .. literalinclude:: ../agentspec_config_examples/howto_structured_generation3.yaml
            :language: yaml

Recap
=====

In this guide, you learned how to perform structured generation using Agent Spec, including configuring LLMs, handling JSON schemas, and integrating with agents for advanced use cases.

.. collapse:: Below is the complete code from this guide.

    .. literalinclude:: ../code_examples/howto_structured_generation.py
        :language: python
        :start-after: .. start-complete
        :end-before: .. end-complete

Next Steps
==========

Having learned how to build flows with structured LLM generation, you may now proceed to:

- :doc:`How to Execute Agent Spec Configuration with WayFlow <howto_execute_agentspec_with_wayflow>`
- :doc:`How to Execute Agent Spec Across Frameworks <howto_execute_agentspec_across_frameworks>`
