# Copyright Â© 2025 Oracle and/or its affiliates.
#
# This software is under the Apache License 2.0
# (LICENSE-APACHE or http://www.apache.org/licenses/LICENSE-2.0) or Universal Permissive License
# (UPL) 1.0 (LICENSE-UPL or https://oss.oracle.com/licenses/upl), at your option.

$referenced_components:

  # Tools
  python_syntax_checker_tool:
    id: "np2bmc823hba"
    type: "ServerTool"
    name: "Python syntax checker"
    description: "Check if the given python code is syntactically correct"
    inputs:
      - title: code
        description: "The python code to check"
        type: string
    outputs:
      - title: is_correct
        type: boolean

  run_python_code_in_sandbox_tool:
    id: "3kjsagh783jka"
    type: "ServerTool"
    name: "Run python in sandbox"
    description: "Run code in a python sandbox and return true if execution was successful"
    inputs:
      - title: code
        description: "The python code to run"
        type: string
    outputs:
      - title: is_successful
        type: boolean

  # ...

  # Agents

  # Main coding agent
  # This agent is reused in several places (gather requirements, generate code, review it)

  coding_agent:
    id: "gtrkj321"
    type: "Agent"
    name: "Coding Agent"
    prompt_template: |
      You are a great coding assistant. Your task is to gather user's requirement and then,
      based on those requirements, generate the python code to perform the task, or review the code if it is already given.
      Please be kind, and follow all the instructions of the user, but do only python code related tasks.
    llm:
      - $ref: oci_genai_llm
    tools:
      - $ref: python_syntax_checker_tool
      - $ref: run_python_code_in_sandbox_tool
    # ...
    inputs:
      - title: generated code
        description: "The python code generated"
        type:
          - string
          - null
        default: null
      - title: review concerns
        description: "The concerns raised by the review"
        type:
          - string
          - null
        default: null
      - title: user request
        description: "The user requirements that were gathered"
        type:
          - string
          - null
        default: null
    outputs:
      - title: generated code
        description: "The python code generated"
        type:
          - string
          - null
        default: null
      - title: review concerns
        description: "The concerns raised by the review"
        type:
          - string
          - null
        default: null
      - title: user request
        description: "The user requirements that were gathered"
        type:
          - string
          - null
        default: null

  # Agent for code security review
  code_security_expert_agent:
    id: "981nj23a"
    type: "Agent"
    name: "Code Security Expert Agent"
    prompt_template: |
      You are a great code security reviewer.
      Check the given user's code and expose all the concerns you have regarding the security of the code.
      This is critical code, so be strict in your judgment, but nice in exposing the concerns.
    llm:
      - $ref: oci_genai_llm
    tools:
      - $ref: ...
    inputs:
      - ...
    # Same as inner agent
    outputs:
      - ...
    # Same as inner agent

  # Nodes in the flow

  gather_requirements_node:
    id: "9ku4323t"
    type: "AgentNode"
    name: "Gather requirements"
    agent:
      - $ref: coding_agent
    inputs:
      - title: generated code
        description: "The python code generated"
        type:
          - string
          - null
        default: null
      - title: review concerns
        description: "The concerns raised by the review"
        type:
          - string
          - null
        default: null
      - title: user request
        description: "The user requirements that were gathered"
        type:
          - string
          - null
        default: null
    outputs:
      - title: generated code
        description: "The python code generated"
        type:
          - string
          - null
        default: null
      - title: review concerns
        description: "The concerns raised by the review"
        type:
          - string
          - null
        default: null
      - title: user request
        description: "The user requirements that were gathered"
        type:
          - string
          - null
        default: null

  code_generator_node:
    id: "yt23qwne"
    type: "AgentNode"
    name: "Code Generator"
    agent:
      - $ref: coding_agent
    inputs:
      - title: generated code
        description: "The python code to review"
        type: string
    outputs:
      - title: review concerns
        description: "The security concerns"
        type: string

  code_reviewer_node:
    id: "83724698"
    type: "AgentNode"
    name: "Code reviewer"
    agent:
      - $ref: coding_agent
    inputs:
      - ...
    # Same as inner agent
    outputs:
      - ...
    # Same as inner agent

  code_security_expert_node:
    id: "i3124bjkgf"
    type: "AgentNode"
    name: "Security Expert"
    agent:
      - $ref: code_security_expert_agent
    inputs:
      - ...
    # Same as inner agent
    outputs:
      - ...
    # Same as inner agent

  start_node:
    id: "8kug123t"
    type: StartNode
    name: "Start of flow"
    input_values: null
    # Inputs and outputs are automatically generated from input_values
    inputs: [ ]
    outputs: [ ]

  end_node:
    id: "8kug123t"
    type: EndNode
    name: "End of flow"
    output_values:
      - title: generated code
        description: "The python code generated"
        type: string
    # Inputs and outputs are automatically generated from output_values
    inputs:
      - title: generated code
        description: "The python code generated"
        type: string
    outputs:
      - title: generated code
        description: "The python code generated"
        type: string


  # Flow edges

  start_to_gather_requirements:
    id: "hqwjne43"
    type: "ControlFlowEdge"
    from_node:
      $ref: start_node
    to_node:
      $ref: gather_requirements_node

  gather_requirements_to_generator:
    id: "hqwjne43"
    type: "ControlFlowEdge"
    from_node:
      $ref: gather_requirements_node  # Coding assistant
    to_node:
      $ref: code_generator_node  # Code generator

  # ...

  # I/O edges

  user_request_to_code_generator_edge:
    id: "a57c10f2"
    type: "DataFlowEdge"
    source_node:
      $ref: gather_requirements_node
    source_output: "user request"
    destination_node:
      $ref: code_generator_node
    destination_input: "user request"

  user_request_to_code_reviewer_edge:
    id: "a57c10f2"
    type: "DataFlowEdge"
    source_node:
      $ref: gather_requirements_node
    source_output: "user request"
    destination_node:
      $ref: code_reviewer_node
    destination_input: "user request"

  code_generated_to_reviewer_edge:
    id: "92c75f51"
    type: "DataFlowEdge"
    source_node:
      $ref: code_generator_node
    source_output: "generated code"
    destination_node:
      $ref: code_reviewer_node
    destination_input: "generated code"

  # ...

  # Flow

  coding_assistant_flow:
    id: "7khg1i34"
    type: "Flow"
    name: "Coding agent flow"
    start_node:
      $ref: start_node
    nodes:
      - $ref: start_node
      - $ref: end_node
      - $ref: gather_requirements_node
      - $ref: code_generator_node
      - $ref: code_reviewer_node
      - $ref: code_security_expert_node
      # ...
    control_flow_connections:
      - $ref: start_to_gather_requirements
      - $ref: gather_requirements_to_generator
      # ...
    data_flow_connections:
      - $ref: user_request_to_code_generator_edge
      - $ref: user_request_to_code_reviewer_edge
      - $ref: code_generated_to_reviewer_edge
      # ...
    inputs: [ ]
    outputs:
      - title: generated code
        description: "The python code generated"
        type: string
